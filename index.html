<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£—á–µ—Ç —Å—Ç–æ–∫–æ–≤ –±–∞—Ä–∞</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Supabase JS –∫–ª–∏–µ–Ω—Ç -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* –í–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π CSS –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        
        body { 
            background: #f5f5f5; 
            padding: 8px; 
            font-size: 14px; 
        }
        
        .container { 
            background: white; 
            border-radius: 10px; 
            padding: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            max-width: 100%;
            overflow: hidden;
        }
        
        h1 { 
            font-size: 20px; 
            margin-bottom: 12px; 
            text-align: center; 
            color: #333; 
        }
        
        /* ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –≤–∞—à CSS –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .notification.success {
            background: #28a745;
            display: block;
        }
        
        .notification.error {
            background: #dc3545;
            display: block;
        }
        
        .notification.info {
            background: #007AFF;
            display: block;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ */
        .btn-sync {
            background: #17a2b8;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –£—á–µ—Ç —Å—Ç–æ–∫–æ–≤ –±–∞—Ä–∞</h1>
        
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
        <div id="notification" class="notification"></div>
        
        <!-- –ü–æ–∏—Å–∫ -->
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" 
                   placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...">
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="action-buttons">
            <button class="action-btn btn-success" onclick="openAddModal('product')">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç
            </button>
            <button class="action-btn btn-secondary" onclick="openAddModal('category')">
                üìÅ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            </button>
            <button class="action-btn btn-sync" onclick="syncWithSupabase()">
                üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
            </button>
        </div>
        
        <!-- –¢–∞–±–ª–∏—Ü–∞ -->
        <div class="table-container">
            <table id="stockTable">
                <thead>
                    <tr>
                        <th class="name-col">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th class="volume-col">–¢–∞—Ä–∞, –º–ª</th>
                        <th class="bar-col">–ë–∞—Ä 1 (–§–∞–∫—Ç)</th>
                        <th class="bar-col">–ë–∞—Ä 2 (–§–∞–∫—Ç)</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
        <div class="action-buttons">
            <button class="action-btn btn-primary" onclick="saveData()">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
            </button>
            <button class="action-btn btn-primary" onclick="saveToSupabase()">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î
            </button>
            <button class="action-btn btn-secondary" onclick="exportData()">
                üì§ –≠–∫—Å–ø–æ—Ä—Ç CSV
            </button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ —á–∏—Å–ª–∞ -->
    <div class="modal" id="numberModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
            <div style="text-align: center; margin-bottom: 15px; color: #666; font-size: 13px;">
                –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—á–∫—É –¥–ª—è –¥—Ä–æ–±–µ–π: 0.5 –∏–ª–∏ 1.5
            </div>
            <input type="number" step="0.1" class="form-input" id="numberInput" 
                   inputmode="decimal" placeholder="0" autofocus>
            <div class="modal-buttons">
                <button class="action-btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="action-btn btn-primary" onclick="confirmNumber()">OK</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-title" id="addModalTitle">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</div>
            
            <div class="form-group">
                <label class="form-label" for="addCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select class="form-input" id="addCategory" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                </select>
            </div>
            
            <div class="form-group" id="nameGroup">
                <label class="form-label" for="addName">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞</label>
                <input type="text" class="form-input" id="addName" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" required>
            </div>
            
            <div class="form-group" id="volumeGroup">
                <label class="form-label" for="addVolume">–û–±—ä–µ–º (–º–ª)</label>
                <input type="number" class="form-input" id="addVolume" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–±—ä–µ–º" min="0" step="1" required>
            </div>
            
            <div class="modal-buttons">
                <button class="action-btn btn-secondary" onclick="closeAddModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="action-btn btn-success" onclick="addItem()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø SUPABASE ===
        // –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–ò –ó–ù–ê–ß–ï–ù–ò–Ø –ù–ê –í–ê–®–ò –î–ê–ù–ù–´–ï –° SUPABASE
        const SUPABASE_URL = 'https://lmysveosqckpbyuldiym.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxteXN2ZW9zcWNrcGJ5dWxkaXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MTMxNTksImV4cCI6MjA4MDM4OTE1OX0.z1i_Fi7uCXnX3cml7RbTHR6RxIrxVY947iOCTi80fQY';
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase –∫–ª–∏–µ–Ω—Ç–∞
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
        let stockData = {
            categories: [],
            products: []
        };
        
        let currentEdit = { type: '', index: -1, field: '' };
        let addModalType = 'product';

        // === –£–¢–ò–õ–ò–¢–´ ===
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }

        // === –†–ê–ë–û–¢–ê –° SUPABASE ===
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Supabase
        async function loadFromSupabase() {
            try {
                showNotification('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã...', 'info');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                const { data: categories, error: catError } = await supabase
                    .from('categories')
                    .select('*')
                    .order('order_index');
                
                if (catError) throw catError;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã
                const { data: products, error: prodError } = await supabase
                    .from('products')
                    .select('*')
                    .order('category_id');
                
                if (prodError) throw prodError;
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –Ω–∞—à —Ñ–æ—Ä–º–∞—Ç
                stockData.categories = categories.map(cat => ({
                    id: cat.id,
                    name: cat.name,
                    order_index: cat.order_index
                }));
                
                stockData.products = products.map(prod => {
                    const category = categories.find(cat => cat.id === prod.category_id);
                    return {
                        id: prod.id,
                        category_id: prod.category_id,
                        category_name: category ? category.name : '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏',
                        name: prod.name,
                        volume: prod.volume,
                        bar1: prod.bar1 || 0,
                        bar2: prod.bar2 || 0
                    };
                });
                
                initTable();
                showNotification('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
                
                // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ localStorage
                loadData();
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ Supabase
        async function saveToSupabase() {
            try {
                showNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...', 'info');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π –ø—Ä–æ–¥—É–∫—Ç –≤ –±–∞–∑–µ
                for (const product of stockData.products) {
                    const { error } = await supabase
                        .from('products')
                        .update({
                            bar1: product.bar1,
                            bar2: product.bar2
                        })
                        .eq('id', product.id);
                    
                    if (error) throw error;
                }
                
                showNotification('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î!', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ Supabase
        async function addProductToSupabase(product) {
            try {
                // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ –∏–º–µ–Ω–∏
                const category = stockData.categories.find(cat => 
                    cat.name.toLowerCase() === product.category.toLowerCase()
                );
                
                let categoryId;
                
                if (category) {
                    categoryId = category.id;
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                    const maxOrder = Math.max(...stockData.categories.map(c => c.order_index), 0);
                    const { data: newCategory, error: catError } = await supabase
                        .from('categories')
                        .insert({
                            name: product.category,
                            order_index: maxOrder + 1
                        })
                        .select()
                        .single();
                    
                    if (catError) throw catError;
                    
                    categoryId = newCategory.id;
                    stockData.categories.push(newCategory);
                }
                
                // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç
                const { data: newProduct, error: prodError } = await supabase
                    .from('products')
                    .insert({
                        category_id: categoryId,
                        name: product.name,
                        volume: product.volume,
                        bar1: 0,
                        bar2: 0
                    })
                    .select()
                    .single();
                
                if (prodError) throw prodError;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç –≤ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                stockData.products.push({
                    ...newProduct,
                    category_name: product.category
                });
                
                return true;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞:', error);
                throw error;
            }
        }

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Supabase
        async function syncWithSupabase() {
            const confirmed = confirm(
                '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∏—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?'
            );
            
            if (confirmed) {
                await loadFromSupabase();
            }
        }

        // === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã
        function initTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            const productsByCategory = {};
            
            stockData.products.forEach(product => {
                const categoryName = product.category_name || product.category;
                if (!productsByCategory[categoryName]) {
                    productsByCategory[categoryName] = [];
                }
                productsByCategory[categoryName].push(product);
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ order_index –∏–ª–∏ –∞–ª—Ñ–∞–≤–∏—Ç—É
            const sortedCategories = Object.keys(productsByCategory).sort((a, b) => {
                const catA = stockData.categories.find(c => c.name === a);
                const catB = stockData.categories.find(c => c.name === b);
                return (catA?.order_index || 999) - (catB?.order_index || 999);
            });
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            sortedCategories.forEach(categoryName => {
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                const categoryRow = document.createElement('tr');
                categoryRow.className = 'category-header';
                categoryRow.innerHTML = `<td colspan="4">${categoryName}</td>`;
                tbody.appendChild(categoryRow);
                
                // –ü—Ä–æ–¥—É–∫—Ç—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                productsByCategory[categoryName].forEach((product, index) => {
                    const globalIndex = stockData.products.findIndex(p => p.id === product.id);
                    const bar1Display = product.bar1 === 0 ? '0' : product.bar1.toString();
                    const bar2Display = product.bar2 === 0 ? '0' : product.bar2.toString();
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="name-col">${product.name}</td>
                        <td class="volume-col">${product.volume}</td>
                        <td class="bar-col number-cell">
                            <button class="number-btn" 
                                    onclick="openNumberInput(${globalIndex}, 'bar1', '${product.name} - –ë–∞—Ä 1')">
                                ${bar1Display}
                            </button>
                        </td>
                        <td class="bar-col number-cell">
                            <button class="number-btn" 
                                    onclick="openNumberInput(${globalIndex}, 'bar2', '${product.name} - –ë–∞—Ä 2')">
                                ${bar2Display}
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ —Å–µ–ª–µ–∫—Ç–µ
            updateCategorySelect();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        function updateCategorySelect() {
            const select = document.getElementById('addCategory');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
            
            stockData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                select.appendChild(option);
            });
        }

        // –ü–æ–∏—Å–∫
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                const tbody = document.getElementById('tableBody');
                const rows = tbody.querySelectorAll('tr');
                
                if (searchTerm === '') {
                    rows.forEach(row => row.style.display = '');
                    return;
                }
                
                let showCategory = false;
                let currentCategory = '';
                
                rows.forEach(row => {
                    if (row.classList.contains('category-header')) {
                        currentCategory = row.cells[0].textContent.toLowerCase();
                        if (currentCategory.includes(searchTerm)) {
                            row.style.display = '';
                            showCategory = true;
                        } else {
                            row.style.display = 'none';
                            showCategory = false;
                        }
                    } else {
                        const productName = row.cells[0].textContent.toLowerCase();
                        const shouldShow = productName.includes(searchTerm) || 
                                          currentCategory.includes(searchTerm) ||
                                          showCategory;
                        row.style.display = shouldShow ? '' : 'none';
                    }
                });
            });
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –≤–≤–æ–¥–∞ —á–∏—Å–ª–∞
        function openNumberInput(index, field, title) {
            currentEdit = { type: 'product', index, field };
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('numberInput').value = stockData.products[index][field] || '';
            document.getElementById('numberModal').style.display = 'flex';
            document.getElementById('numberInput').focus();
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤–≤–æ–¥–∞ —á–∏—Å–ª–∞
        function confirmNumber() {
            let value = document.getElementById('numberInput').value.trim();
            value = value.replace(',', '.');
            const numericValue = parseFloat(value);
            
            if (currentEdit.index !== -1) {
                if (!isNaN(numericValue)) {
                    stockData.products[currentEdit.index][currentEdit.field] = numericValue;
                } else if (value === '') {
                    stockData.products[currentEdit.index][currentEdit.field] = 0;
                } else {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ');
                    return;
                }
                initTable();
            }
            
            closeModal();
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeModal() {
            document.getElementById('numberModal').style.display = 'none';
            currentEdit = { type: '', index: -1, field: '' };
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        function openAddModal(type) {
            addModalType = type;
            const modal = document.getElementById('addModal');
            const title = document.getElementById('addModalTitle');
            const nameGroup = document.getElementById('nameGroup');
            const volumeGroup = document.getElementById('volumeGroup');
            
            if (type === 'category') {
                title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
                nameGroup.style.display = 'none';
                volumeGroup.style.display = 'none';
            } else {
                title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç';
                nameGroup.style.display = 'block';
                volumeGroup.style.display = 'block';
            }
            
            document.getElementById('addCategory').value = '';
            document.getElementById('addName').value = '';
            document.getElementById('addVolume').value = '';
            
            modal.style.display = 'flex';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
        async function addItem() {
            const category = document.getElementById('addCategory').value.trim();
            const name = document.getElementById('addName').value.trim();
            const volume = document.getElementById('addVolume').value;
            
            if (!category) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
                return;
            }
            
            if (addModalType === 'category') {
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                const categoryExists = stockData.categories.some(c => 
                    c.name.toLowerCase() === category.toLowerCase()
                );
                
                if (!categoryExists) {
                    try {
                        const maxOrder = Math.max(...stockData.categories.map(c => c.order_index), 0);
                        const { data: newCategory, error } = await supabase
                            .from('categories')
                            .insert({
                                name: category,
                                order_index: maxOrder + 1
                            })
                            .select()
                            .single();
                        
                        if (error) throw error;
                        
                        stockData.categories.push(newCategory);
                        updateCategorySelect();
                        showNotification(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${category}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`, 'success');
                    } catch (error) {
                        showNotification('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ' + error.message, 'error');
                    }
                } else {
                    alert('–¢–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                }
            } else {
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
                if (!name) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞');
                    return;
                }
                
                if (!volume || volume <= 0) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ–±—ä–µ–º');
                    return;
                }
                
                try {
                    const productData = {
                        category: category,
                        name: name,
                        volume: parseInt(volume),
                        bar1: 0,
                        bar2: 0
                    };
                    
                    await addProductToSupabase(productData);
                    
                    initTable();
                    showNotification(`–ü—Ä–æ–¥—É–∫—Ç "${name}" –¥–æ–±–∞–≤–ª–µ–Ω`, 'success');
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞: ' + error.message, 'error');
                }
            }
            
            closeAddModal();
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ª–æ–∫–∞–ª—å–Ω–æ
        function saveData() {
            localStorage.setItem('barStockData_backup', JSON.stringify(stockData));
            showNotification('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ!', 'success', 2000);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ª–æ–∫–∞–ª—å–Ω–æ
        function loadData() {
            const saved = localStorage.getItem('barStockData_backup');
            if (saved) {
                try {
                    const savedData = JSON.parse(saved);
                    if (savedData.products && savedData.products.length > 0) {
                        stockData = savedData;
                        initTable();
                        showNotification('–õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'info');
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
                }
            }
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
        function exportData() {
            const BOM = '\uFEFF';
            let csv = BOM + '–ö–∞—Ç–µ–≥–æ—Ä–∏—è;–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ;–¢–∞—Ä–∞ –º–ª;–ë–∞—Ä 1 (–§–∞–∫—Ç);–ë–∞—Ä 2 (–§–∞–∫—Ç)\r\n';
            
            stockData.products.forEach(product => {
                const category = `"${(product.category_name || product.category).replace(/"/g, '""')}"`;
                const name = `"${product.name.replace(/"/g, '""')}"`;
                const bar1 = (product.bar1 || 0).toString().replace(',', '.');
                const bar2 = (product.bar2 || 0).toString().replace(',', '.');
                csv += `${category};${name};${product.volume};${bar1};${bar2}\r\n`;
            });
            
            const blob = new Blob([csv], { 
                type: 'text/csv;charset=utf-8' 
            });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `—Å—Ç–æ–∫–∏_–±–∞—Ä–∞_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('CSV —Ñ–∞–π–ª —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è...', 'success');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = async function() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
            showNotification('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...', 'info');
            
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Supabase
            await loadFromSupabase();
            
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Supabase, –≥—Ä—É–∑–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            if (stockData.products.length === 0) {
                loadData();
            }
            
            initTable();
            setupSearch();
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
            window.onclick = function(event) {
                const modals = ['numberModal', 'addModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (event.target === modal) {
                        if (modalId === 'numberModal') closeModal();
                        if (modalId === 'addModal') closeAddModal();
                    }
                });
            };
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter/Escape
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    if (document.getElementById('numberModal').style.display === 'flex') {
                        confirmNumber();
                    }
                    if (document.getElementById('addModal').style.display === 'flex') {
                        addItem();
                    }
                }
                if (event.key === 'Escape') {
                    closeModal();
                    closeAddModal();
                }
            });
        };
    </script>
</body>
</html>
