<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£—á–µ—Ç —Å—Ç–æ–∫–æ–≤ –±–∞—Ä–∞</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* –í–ê–® CSS –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô */
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        
        body { 
            background: #f5f5f5; 
            padding: 8px; 
            font-size: 14px; 
        }
        
        .container { 
            background: white; 
            border-radius: 10px; 
            padding: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            max-width: 100%;
            overflow: hidden;
        }
        
        h1 { 
            font-size: 20px; 
            margin-bottom: 12px; 
            text-align: center; 
            color: #333; 
        }
        
        /* –ü–æ–∏—Å–∫ */
        .search-container { 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            background: white; 
            padding: 8px 0 10px 0; 
            margin-bottom: 8px;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            background: #f8f9fa;
        }
        
        /* –¢–∞–±–ª–∏—Ü–∞ - –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è */
        .table-container { 
            overflow-x: auto; 
            margin-bottom: 15px; 
            border: 1px solid #e0e0e0; 
            border-radius: 6px;
            -webkit-overflow-scrolling: touch;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 360px;
            font-size: 13px;
        }
        
        th, td { 
            padding: 6px 4px; 
            border-bottom: 1px solid #e0e0e0; 
            text-align: left;
            vertical-align: middle;
        }
        
        th { 
            background: #f8f9fa; 
            font-weight: 600; 
            color: #555; 
            font-size: 12px;
            white-space: nowrap;
            position: sticky;
            top: 0;
        }
        
        /* –ö–æ–ª–æ–Ω–∫–∏ */
        .name-col { 
            width: 45%; 
            min-width: 140px;
            padding-right: 2px;
        }
        
        .volume-col { 
            width: 15%; 
            min-width: 50px;
            padding-right: 2px;
        }
        
        .bar-col { 
            width: 20%; 
            min-width: 70px;
            text-align: center !important;
        }
        
        /* –ö–∞—Ç–µ–≥–æ—Ä–∏—è */
        .category-header { 
            background: #e8f4ff; 
            font-weight: 600; 
            color: #1976d2; 
            font-size: 13px;
        }
        
        /* –Ø—á–µ–π–∫–∏ —Å –∫–Ω–æ–ø–∫–∞–º–∏ - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ */
        .number-cell {
            padding: 2px 4px !important;
            text-align: center;
        }
        
        .number-btn {
            width: 100%;
            min-height: 30px;
            height: 30px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0 4px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .number-btn:hover, .number-btn:active {
            background: #f0f0f0;
            border-color: #007AFF;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        
        .action-btn {
            flex: 1;
            min-width: calc(50% - 4px);
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #007AFF;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 350px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 4px;
            font-size: 13px;
            color: #555;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #007AFF;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è iPhone 12 (375x812) */
        @media (max-width: 390px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 10px;
            }
            
            th, td {
                padding: 4px 3px;
                font-size: 12px;
            }
            
            .name-col {
                min-width: 120px;
            }
            
            .number-btn {
                min-height: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            .action-btn {
                padding: 8px 10px;
                font-size: 12px;
            }
        }
        
        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è OLED */
        @media (prefers-color-scheme: dark) {
            body {
                background: #000;
                color: #fff;
            }
            
            .container {
                background: #1c1c1e;
            }
            
            .search-input {
                background: #2c2c2e;
                border-color: #3a3a3c;
                color: #fff;
            }
            
            table {
                border-color: #3a3a3c;
            }
            
            th {
                background: #2c2c2e;
                color: #8e8e93;
            }
            
            td {
                border-color: #3a3a3c;
            }
            
            .category-header {
                background: #2c2c2e;
                color: #0a84ff;
            }
            
            .number-btn {
                background: #2c2c2e;
                border-color: #3a3a3c;
                color: #fff;
            }
            
            .modal-content {
                background: #1c1c1e;
                color: #fff;
            }
            
            .form-input {
                background: #2c2c2e;
                border-color: #3a3a3c;
                color: #fff;
            }
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .notification.success {
            background: #28a745;
            display: block;
        }
        
        .notification.error {
            background: #dc3545;
            display: block;
        }
        
        .notification.info {
            background: #007AFF;
            display: block;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ */
        .btn-sync {
            background: #17a2b8;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –£—á–µ—Ç —Å—Ç–æ–∫–æ–≤ –±–∞—Ä–∞</h1>
        
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
        <div id="notification" class="notification"></div>
        
        <!-- –ü–æ–∏—Å–∫ -->
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" 
                   placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...">
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="action-buttons">
            <button class="action-btn btn-success" onclick="openAddModal('product')">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç
            </button>
            <button class="action-btn btn-secondary" onclick="openAddModal('category')">
                üìÅ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            </button>
            <button class="action-btn btn-sync" onclick="syncWithSupabase()">
                üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
            </button>
        </div>
        
        <!-- –¢–∞–±–ª–∏—Ü–∞ -->
        <div class="table-container">
            <table id="stockTable">
                <thead>
                    <tr>
                        <th class="name-col">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th class="volume-col">–¢–∞—Ä–∞, –º–ª</th>
                        <th class="bar-col">–ë–∞—Ä 1 (–§–∞–∫—Ç)</th>
                        <th class="bar-col">–ë–∞—Ä 2 (–§–∞–∫—Ç)</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
        <div class="action-buttons">
            <button class="action-btn btn-primary" onclick="saveData()">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
            </button>
            <button class="action-btn btn-primary" onclick="saveToSupabase()">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î
            </button>
            <button class="action-btn btn-secondary" onclick="exportData()">
                üì§ –≠–∫—Å–ø–æ—Ä—Ç CSV
            </button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ —á–∏—Å–ª–∞ -->
    <div class="modal" id="numberModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
            <div style="text-align: center; margin-bottom: 15px; color: #666; font-size: 13px;">
                –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—á–∫—É –¥–ª—è –¥—Ä–æ–±–µ–π: 0.5 –∏–ª–∏ 1.5
            </div>
            <input type="number" step="0.1" class="form-input" id="numberInput" 
                   inputmode="decimal" placeholder="0" autofocus>
            <div class="modal-buttons">
                <button class="action-btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="action-btn btn-primary" onclick="confirmNumber()">OK</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-title" id="addModalTitle">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</div>
            
            <div class="form-group">
                <label class="form-label" for="addCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select class="form-input" id="addCategory" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                </select>
            </div>
            
            <div class="form-group" id="nameGroup">
                <label class="form-label" for="addName">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞</label>
                <input type="text" class="form-input" id="addName" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" required>
            </div>
            
            <div class="form-group" id="volumeGroup">
                <label class="form-label" for="addVolume">–û–±—ä–µ–º (–º–ª)</label>
                <input type="number" class="form-input" id="addVolume" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–±—ä–µ–º" min="0" step="1" required>
            </div>
            
            <div class="modal-buttons">
                <button class="action-btn btn-secondary" onclick="closeAddModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="action-btn btn-success" onclick="addItem()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø SUPABASE ===
        // –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–ò –ó–ù–ê–ß–ï–ù–ò–Ø –ù–ê –í–ê–®–ò –î–ê–ù–ù–´–ï!
        const SUPABASE_URL = 'https://lmysveosqckpbyuldiym.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxteXN2ZW9zcWNrcGJ5dWxkaXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MTMxNTksImV4cCI6MjA4MDM4OTE1OX0.z1i_Fi7uCXnX3cml7RbTHR6RxIrxVY947iOCTi80fQY';
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase:', error);
        }
        
        // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
        let stockData = {
            categories: [],
            products: []
        };
        
        let currentEdit = { type: '', index: -1, field: '' };
        let addModalType = 'product';
        
        // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
        
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = message;
                notification.className = 'notification ' + type;
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, duration);
            }
        }
        
        // === –†–ê–ë–û–¢–ê –° –õ–û–ö–ê–õ–¨–ù–´–ú –•–†–ê–ù–ò–õ–ò–©–ï–ú ===
        
        function saveData() {
            try {
                localStorage.setItem('barStockData', JSON.stringify(stockData));
                showNotification('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ!', 'success');
                return true;
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
                return false;
            }
        }
        
        function loadData() {
            try {
                const saved = localStorage.getItem('barStockData');
                if (saved) {
                    stockData = JSON.parse(saved);
                    initTable();
                    return true;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            }
            return false;
        }
        
        // === –†–ê–ë–û–¢–ê –° SUPABASE ===
        
        async function loadFromSupabase() {
            try {
                showNotification('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã...', 'info');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                const { data: categories, error: catError } = await supabase
                    .from('categories')
                    .select('*')
                    .order('order_index');
                
                if (catError) throw catError;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã
                const { data: products, error: prodError } = await supabase
                    .from('products')
                    .select('*')
                    .order('category_id');
                
                if (prodError) throw prodError;
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
                stockData.categories = categories;
                stockData.products = products.map(prod => {
                    const category = categories.find(cat => cat.id === prod.category_id);
                    return {
                        ...prod,
                        category_name: category ? category.name : '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'
                    };
                });
                
                initTable();
                saveData(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –∫–∞–∫ –∫—ç—à
                showNotification('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –ë–î. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', 'error');
                loadData(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage
            }
        }
        
        async function saveToSupabase() {
            try {
                showNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...', 'info');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π –ø—Ä–æ–¥—É–∫—Ç
                for (const product of stockData.products) {
                    const { error } = await supabase
                        .from('products')
                        .update({
                            bar1: product.bar1,
                            bar2: product.bar2
                        })
                        .eq('id', product.id);
                    
                    if (error) throw error;
                }
                
                showNotification('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î!', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }
        
        async function syncWithSupabase() {
            if (confirm('–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã? –¢–µ–∫—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                await loadFromSupabase();
            }
        }
        
        // === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ===
        
        function initTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            const productsByCategory = {};
            
            stockData.products.forEach(product => {
                const categoryName = product.category_name || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
                if (!productsByCategory[categoryName]) {
                    productsByCategory[categoryName] = [];
                }
                productsByCategory[categoryName].push(product);
            });
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            Object.keys(productsByCategory).forEach(categoryName => {
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                const categoryRow = document.createElement('tr');
                categoryRow.className = 'category-header';
                categoryRow.innerHTML = `<td colspan="4">${categoryName}</td>`;
                tbody.appendChild(categoryRow);
                
                // –ü—Ä–æ–¥—É–∫—Ç—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                productsByCategory[categoryName].forEach((product, index) => {
                    const globalIndex = stockData.products.findIndex(p => p.id === product.id);
                    const bar1Display = product.bar1 === 0 ? '0' : product.bar1.toString();
                    const bar2Display = product.bar2 === 0 ? '0' : product.bar2.toString();
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="name-col">${product.name}</td>
                        <td class="volume-col">${product.volume}</td>
                        <td class="bar-col number-cell">
                            <button class="number-btn" 
                                    onclick="openNumberInput(${globalIndex}, 'bar1', '${product.name} - –ë–∞—Ä 1')">
                                ${bar1Display}
                            </button>
                        </td>
                        <td class="bar-col number-cell">
                            <button class="number-btn" 
                                    onclick="openNumberInput(${globalIndex}, 'bar2', '${product.name} - –ë–∞—Ä 2')">
                                ${bar2Display}
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            updateCategorySelect();
        }
        
        function updateCategorySelect() {
            const select = document.getElementById('addCategory');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
            
            stockData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                select.appendChild(option);
            });
        }
        
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                const tbody = document.getElementById('tableBody');
                const rows = tbody.querySelectorAll('tr');
                
                if (searchTerm === '') {
                    rows.forEach(row => row.style.display = '');
                    return;
                }
                
                let showCategory = false;
                let currentCategory = '';
                
                rows.forEach(row => {
                    if (row.classList.contains('category-header')) {
                        currentCategory = row.cells[0].textContent.toLowerCase();
                        if (currentCategory.includes(searchTerm)) {
                            row.style.display = '';
                            showCategory = true;
                        } else {
                            row.style.display = 'none';
                            showCategory = false;
                        }
                    } else {
                        const productName = row.cells[0].textContent.toLowerCase();
                        const shouldShow = productName.includes(searchTerm) || 
                                          currentCategory.includes(searchTerm) ||
                                          showCategory;
                        row.style.display = shouldShow ? '' : 'none';
                    }
                });
            });
        }
        
        function openNumberInput(index, field, title) {
            currentEdit = { type: 'product', index, field };
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('numberInput').value = stockData.products[index][field] || '';
            document.getElementById('numberModal').style.display = 'flex';
            document.getElementById('numberInput').focus();
        }
        
        function confirmNumber() {
            let value = document.getElementById('numberInput').value.trim();
            value = value.replace(',', '.');
            const numericValue = parseFloat(value);
            
            if (currentEdit.index !== -1) {
                if (!isNaN(numericValue)) {
                    stockData.products[currentEdit.index][currentEdit.field] = numericValue;
                } else if (value === '') {
                    stockData.products[currentEdit.index][currentEdit.field] = 0;
                } else {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ');
                    return;
                }
                initTable();
            }
            
            closeModal();
        }
        
        function closeModal() {
            document.getElementById('numberModal').style.display = 'none';
            currentEdit = { type: '', index: -1, field: '' };
        }
        
        function openAddModal(type) {
            addModalType = type;
            const modal = document.getElementById('addModal');
            const title = document.getElementById('addModalTitle');
            const nameGroup = document.getElementById('nameGroup');
            const volumeGroup = document.getElementById('volumeGroup');
            
            if (type === 'category') {
                title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
                nameGroup.style.display = 'none';
                volumeGroup.style.display = 'none';
            } else {
                title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç';
                nameGroup.style.display = 'block';
                volumeGroup.style.display = 'block';
            }
            
            document.getElementById('addCategory').value = '';
            document.getElementById('addName').value = '';
            document.getElementById('addVolume').value = '';
            
            modal.style.display = 'flex';
        }
        
        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
        }
        
        function addItem() {
            const category = document.getElementById('addCategory').value.trim();
            const name = document.getElementById('addName').value.trim();
            const volume = document.getElementById('addVolume').value;
            
            if (!category) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
                return;
            }
            
            if (addModalType === 'category') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
                const categoryExists = stockData.categories.some(c => 
                    c.name.toLowerCase() === category.toLowerCase()
                );
                
                if (!categoryExists) {
                    const newCategory = {
                        id: Date.now(), // –í—Ä–µ–º–µ–Ω–Ω—ã–π ID
                        name: category,
                        order_index: stockData.categories.length + 1
                    };
                    
                    stockData.categories.push(newCategory);
                    updateCategorySelect();
                    showNotification(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${category}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`, 'success');
                } else {
                    alert('–¢–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                }
            } else {
                if (!name) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞');
                    return;
                }
                
                if (!volume || volume <= 0) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ–±—ä–µ–º');
                    return;
                }
                
                // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                const categoryObj = stockData.categories.find(c => 
                    c.name.toLowerCase() === category.toLowerCase()
                );
                
                if (!categoryObj) {
                    alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    return;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç
                const newProduct = {
                    id: Date.now(), // –í—Ä–µ–º–µ–Ω–Ω—ã–π ID
                    category_id: categoryObj.id,
                    name: name,
                    volume: parseInt(volume),
                    bar1: 0,
                    bar2: 0,
                    category_name: category
                };
                
                stockData.products.push(newProduct);
                initTable();
                showNotification(`–ü—Ä–æ–¥—É–∫—Ç "${name}" –¥–æ–±–∞–≤–ª–µ–Ω`, 'success');
            }
            
            closeAddModal();
        }
        
        function exportData() {
            const BOM = '\uFEFF';
            let csv = BOM + '–ö–∞—Ç–µ–≥–æ—Ä–∏—è;–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ;–¢–∞—Ä–∞ –º–ª;–ë–∞—Ä 1 (–§–∞–∫—Ç);–ë–∞—Ä 2 (–§–∞–∫—Ç)\r\n';
            
            stockData.products.forEach(product => {
                const category = `"${(product.category_name || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏').replace(/"/g, '""')}"`;
                const name = `"${product.name.replace(/"/g, '""')}"`;
                const bar1 = (product.bar1 || 0).toString().replace(',', '.');
                const bar2 = (product.bar2 || 0).toString().replace(',', '.');
                csv += `${category};${name};${product.volume};${bar1};${bar2}\r\n`;
            });
            
            const blob = new Blob([csv], { 
                type: 'text/csv;charset=utf-8' 
            });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `—Å—Ç–æ–∫–∏_–±–∞—Ä–∞_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('CSV —Ñ–∞–π–ª —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è...', 'success');
        }
        
        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
        window.onload = async function() {
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            if (!loadData() || stockData.products.length === 0) {
                // –ï—Å–ª–∏ –Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Supabase
                if (supabase && SUPABASE_URL && SUPABASE_ANON_KEY) {
                    await loadFromSupabase();
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç Supabase, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—É—é —Ç–∞–±–ª–∏—Ü—É
                    showNotification('–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase', 'info');
                    initTable();
                }
            }
            
            setupSearch();
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            window.onclick = function(event) {
                if (event.target.id === 'numberModal') closeModal();
                if (event.target.id === 'addModal') closeAddModal();
            };
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    if (document.getElementById('numberModal').style.display === 'flex') {
                        confirmNumber();
                    }
                    if (document.getElementById('addModal').style.display === 'flex') {
                        addItem();
                    }
                }
                if (event.key === 'Escape') {
                    closeModal();
                    closeAddModal();
                }
            });
        };
    </script>
</body>
</html>
